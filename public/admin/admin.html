<!doctype html>
<html class="no-js" lang="en">

<head>
<title>GISP Admin</title>

	
	<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
	<link href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet">

<script>
	function getMapList() {
		var url = "/getExistingMaps";
		$.ajax(url, {
			type: "GET",
			url: url,
			dataType: "json",
			success: function(data){
			console.log(data);

				var urls = [];
				var titles = [];
				var subtitles = [];
				var descriptions = [];
				var repos = [];
				var nids = [];
				var vids = [];
				var create_tss = [];
				var zooms = [];
				var center_lats = [];
				var center_lons = [];
				var searches = [];
				
				for (var i = 1; i < data.length; i++) {

					var title = data[i].title;
					var nid = data[i].nid;
					console.log(i, nid);
					var vid = data[i].vid;
					var created = data[i].created;
					var changed = data[i].changed;
					var updated = ""
					if (data[i].fields.field_date_updated_reviewed.und) {
					updated = data[i].fields.field_date_updated_reviewed.und[0].value;
					}
					var url = "";
					if (data[i].fields.field_map_page_url.und) {
						url = data[i].fields.field_map_page_url.und[0].url;
					}
					var repo = "";
					if (data[i].fields.field_map_repository.und) {
						repo = data[i].fields.field_map_repository.und[0].url;
					}
					var subtitle = "";
					if (data[i].fields.field_subtitle.und) {
					subtitle = data[i].fields.field_subtitle.und[0].value;
					}
					
					if ( url+repo != "") {
						urls.push(url);
						titles.push(title);
						subtitles.push(subtitle);
						descriptions.push("Descriptions go here");
						nids.push(nid);
						vids.push(vid);
						create_tss.push(created);
						repos.push(repo);
						
						var map_info = "";
						if (data[i].fields.field_description.und) {
							var value_str = data[i].fields.field_description.und[0].value;
							var map_info = JSON.parse(value_str);
						}
						if (map_info != "") {
						zooms.push(map_info.mapzoom.initialzoom);
						center_lats.push(map_info.mapcenter.latitude);
						center_lons.push(map_info.mapcenter.longitude);
						}
						else {
						zooms.push(3);
						center_lats.push(40);
						center_lons.push(-105);
						}
					}
				
				}
				
				var text = "<table border=1 cellspacing=0 cellpadding=3><tr><td>#</td><td>Map Title</td><td>Map ID</td><td>Version ID</td><td>URL</td><td>Repo</td><td>Last Updated</td><td>Action</td><tr>";
				
				for (var i = 0; i < urls.length; i++) {
				var action_text = "";
				if (repos[i] != "") {
				action_text = "<span id=\"" + nids[i] + "\" class=\"span-pull-github\" style=\"cursor: pointer; color: #0000ff\">Pull Github Repo</span>";
				}
				
				var url_bookmark = "/" + urls[i] + "/#" + zooms[i] + "/" + center_lats[i] + "/" + center_lons[i] + "/zoom,attr,layers,key,search";
				var ii = i + 1;
				
				text += "<tr><td>" + ii + "</td><td><a href=\"" + url_bookmark + "\">" +  titles[i] + "</a></td><td>" + nids[i] + "</td><td>" + vids[i] + "</td><td>" + urls[i] + "</td><td>" + repos[i] + "</td><td>" + create_tss[i] + "</td><td>" + action_text + "</td>" +  "</tr>";
				
				
				}
				
				text += "</table>";
				
				$('#map-list-display').html(text);
				$('.span-pull-github').on("click", function(e) {
					var nid = e.target.id;
					
					pullRepo(nid);
				});

			
			}
		});
	
	
	}


	function pullDrupal() {
		var url = "/pullDrupal";
		
		$.ajax(url, {
			type: "GET",
			url: url,
			dataType: "json",
			success: function(data){
				if (data.status == "ok") {
					alert("Drupal API has been pulled");
				}
				else {
					alert("error occured during API pull");
				}
			}
		});
	
	}
	
	
	function pullRepo(nid) {
		var url = "/pullRepo/" + nid;
		console.log(url);
		
		$.ajax(url, {
			type: "GET",
			url: url,
			dataType: "json",
			success: function(data){
				if (data.status == "ok") {
					alert("Repo has been pulled");
				}
				else {
					alert("error occured during Repo pull");
				}
			}
		});
		
		
	
	
	}
	

	
$(document).ready(function() {
getMapList();

$('#pull-drupal').on("click", function(e) {
	pullDrupal();
});

$('#refresh-map-list').on("click", function(e) {
	getMapList();
});




});

</script>




	
</head>

<body>

<h3>
<span id="pull-drupal" style="color: #0000ff; cursor: pointer">Pull Drupal API</span>
</h3>

<div id="map-list-display">
</div>
<span id="refresh-map-list" style="color: #0000ff; cursor: pointer">Refresh Map List</span>




</body>

</html>
